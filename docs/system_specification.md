# システム仕様書

## 1. システム概要

このシステムは、Next.jsとPrismaを使用した管理者向けのログイン・認証システムです。ユーザーは権限に基づいて様々なアプリケーションにアクセスできるポータルサイトとなっています。

### 主な機能
- ユーザー認証（ログイン/ログアウト）
- ロールベースのアクセス制御（RBAC）
- ユーザー管理（作成、閲覧、更新、削除）
- ロール管理（作成、閲覧、更新、削除）
- アプリケーションポータル（権限に基づいたアプリケーション一覧表示）
- アプリケーションごとの戻るボタン制御（ブラウザの戻る操作の許可/禁止）

## 2. テーブル構成

### Roleテーブル
| フィールド名 | データ型 | 説明 |
|------------|---------|------|
| id | String | 主キー、CUID形式 |
| name | String | ロール名（一意） |
| description | String? | ロールの説明（任意） |
| permissions | String[] | 権限のリスト |
| createdAt | DateTime | 作成日時 |
| updatedAt | DateTime | 更新日時 |

### Userテーブル
| フィールド名 | データ型 | 説明 |
|------------|---------|------|
| id | String | 主キー、CUID形式 |
| name | String? | ユーザー名（任意） |
| email | String? | メールアドレス（一意） |
| password | String? | ハッシュ化されたパスワード |
| image | String? | プロフィール画像URL（任意） |
| roleId | String? | 外部キー（Roleテーブルへの参照） |
| createdAt | DateTime | 作成日時 |
| updatedAt | DateTime | 更新日時 |

## 3. ER図

```
+----------------+       +----------------+
|      Role      |       |      User      |
+----------------+       +----------------+
| id (PK)        |       | id (PK)        |
| name           |       | name           |
| description    |       | email          |
| permissions    |       | password       |
| createdAt      |       | image          |
| updatedAt      |       | roleId (FK)    |
|                |       | createdAt      |
|                |       | updatedAt      |
+----------------+       +----------------+
        |                        |
        |                        |
        +------------------------+
                  1:N
```

## 4. API仕様

### 認証API

#### POST /api/auth/[...nextauth]
- 説明: NextAuthによる認証エンドポイント
- リクエストボディ:
  - email: メールアドレス
  - password: パスワード
- レスポンス:
  - 成功: JWTトークンとユーザー情報
  - エラー: 認証エラーメッセージ

#### POST /api/auth/change-password
- 説明: パスワード変更エンドポイント
- 認証: 必要
- リクエストボディ:
  - currentPassword: 現在のパスワード
  - newPassword: 新しいパスワード
- レスポンス:
  - 成功: 成功メッセージ
  - エラー: エラーメッセージ

### ユーザーAPI

#### GET /api/users
- 説明: ユーザー一覧取得
- 認証: 必要
- 権限: user:read
- レスポンス:
  - 成功: ユーザー一覧
  - エラー: エラーメッセージ

#### POST /api/users
- 説明: 新規ユーザー作成
- 認証: 必要
- 権限: user:create
- リクエストボディ:
  - name: ユーザー名
  - email: メールアドレス
  - password: パスワード
  - roleId: ロールID
- レスポンス:
  - 成功: 作成されたユーザー情報
  - エラー: エラーメッセージ

#### GET /api/users/[id]
- 説明: 特定ユーザー情報取得
- 認証: 必要
- 権限: user:read
- レスポンス:
  - 成功: ユーザー情報
  - エラー: エラーメッセージ

#### PUT /api/users/[id]
- 説明: ユーザー情報更新
- 認証: 必要
- 権限: user:update
- リクエストボディ:
  - name?: ユーザー名
  - email?: メールアドレス
  - roleId?: ロールID
- レスポンス:
  - 成功: 更新されたユーザー情報
  - エラー: エラーメッセージ

#### DELETE /api/users/[id]
- 説明: ユーザー削除
- 認証: 必要
- 権限: user:delete
- レスポンス:
  - 成功: 削除成功メッセージ
  - エラー: エラーメッセージ

### ロールAPI

#### GET /api/roles
- 説明: ロール一覧取得
- 認証: 必要
- 権限: role:read
- レスポンス:
  - 成功: ロール一覧
  - エラー: エラーメッセージ

#### POST /api/roles
- 説明: 新規ロール作成
- 認証: 必要
- 権限: role:create
- リクエストボディ:
  - name: ロール名
  - description?: ロールの説明
  - permissions: 権限リスト
- レスポンス:
  - 成功: 作成されたロール情報
  - エラー: エラーメッセージ

#### GET /api/roles/[id]
- 説明: 特定ロール情報取得
- 認証: 必要
- 権限: role:read
- レスポンス:
  - 成功: ロール情報
  - エラー: エラーメッセージ

#### PUT /api/roles/[id]
- 説明: ロール情報更新
- 認証: 必要
- 権限: role:update
- リクエストボディ:
  - name?: ロール名
  - description?: ロールの説明
  - permissions?: 権限リスト
- レスポンス:
  - 成功: 更新されたロール情報
  - エラー: エラーメッセージ

#### DELETE /api/roles/[id]
- 説明: ロール削除
- 認証: 必要
- 権限: role:delete
- レスポンス:
  - 成功: 削除成功メッセージ
  - エラー: エラーメッセージ

## 5. 権限システム

システムは以下の権限を持つロールベースのアクセス制御を実装しています：

### 権限一覧
- user:create - ユーザー作成権限
- user:read - ユーザー閲覧権限
- user:update - ユーザー更新権限
- user:delete - ユーザー削除権限
- role:create - ロール作成権限
- role:read - ロール閲覧権限
- role:update - ロール更新権限
- role:delete - ロール削除権限
- settings:read - 設定閲覧権限
- settings:update - 設定更新権限
- page:demo1 - デモ1アプリケーションアクセス権限
- page:demo2 - デモ2アプリケーションアクセス権限

### デフォルトロール
1. admin（管理者）
   - すべての権限を持つ
2. user（一般ユーザー）
   - user:read のみ
3. viewer（閲覧者）
   - user:read のみ

## 6. アプリケーションポータル

システムは権限に基づいてアクセス可能なアプリケーションを表示するポータル機能を提供します。

### アプリケーション一覧
1. デモ1アプリケーション
   - ID: demo1
   - 説明: シンプルなUIと基本機能を備えたデモアプリ
   - 必要権限: page:demo1
   - カテゴリ: デモ
   - タグ: 基本, シンプル
   - 戻るボタン制御: 無効（戻る操作可能）

2. デモ2アプリケーション
   - ID: demo2
   - 説明: タブインターフェースを使った高度なデモアプリ
   - 必要権限: page:demo2
   - カテゴリ: デモ
   - タグ: 高度, タブ
   - 戻るボタン制御: 有効（戻る操作禁止）

### 戻るボタン制御機能

システムは特定のアプリケーションで戻るボタンの操作を禁止する機能を提供しています。この機能は以下の方法で実装されています：

1. **設定方法**
   - アプリケーション定義の `preventNavigationBack` プロパティで制御
   - true: 戻るボタン操作を禁止
   - false: 戻るボタン操作を許可

2. **実装方法**
   - 共通レイアウト（layout.tsx）で一元管理
   - 各ページコンポーネントでもアプリケーション設定を取得して表示に反映
   - ブラウザの戻るボタン、キーボードショートカット（Alt+←）、その他の戻る操作を無効化
   - 戻る操作が検出された場合、アラートを表示
   - 履歴スタックを操作して戻るボタンを無効化
   - セッションストレージを使用して現在のURLを保存

3. **ユーザー体験**
   - 戻るボタンが禁止されているアプリでは、ダッシュボードに戻るボタンを使用して移動する必要がある
   - ダッシュボードに戻る際は、セッションストレージをクリアして正常に遷移できるよう処理
   - 戻るボタンが許可されているアプリでは、通常のブラウザ操作が可能
   - ユーザーには戻るボタンの状態が視覚的に表示される

この機能は、特定のアプリケーションでユーザーが誤って戻るボタンを押してデータを失うことを防止するために実装されています。また、セキュリティが重要なアプリケーションで意図しない画面遷移を防ぐ目的もあります。

## 7. システムの特徴

1. **セキュアな認証システム**
   - NextAuthを使用したJWTベースの認証
   - パスワードはbcryptでハッシュ化して保存
   - ログイン情報の保存機能（オプション）

2. **柔軟な権限管理**
   - ロールベースのアクセス制御
   - 細かい粒度の権限設定
   - 権限に基づいたUI要素の表示/非表示

3. **モダンなUI/UX**
   - レスポンシブデザイン
   - アニメーション効果
   - ダークモード対応（tailwindcssによる）
   - アプリケーションごとの戻るボタン制御

4. **拡張性の高いアーキテクチャ**
   - Next.jsのApp Routerを使用
   - Prisma ORMによるデータベース操作
   - 型安全なTypeScriptコード

## 8. 技術スタック

- **フロントエンド**
  - Next.js (App Router)
  - React
  - TypeScript
  - Tailwind CSS
  - shadcn/ui (UIコンポーネント)
  - Framer Motion (アニメーション)

- **バックエンド**
  - Next.js API Routes
  - Prisma ORM
  - NextAuth.js (認証)
  - bcrypt (パスワードハッシュ化)

- **データベース**
  - PostgreSQL

## 9. システムフロー

1. **ユーザーログイン**
   - ユーザーがログインページにアクセス
   - メールアドレスとパスワードを入力
   - 認証成功時、JWTトークンが発行され、ダッシュボードにリダイレクト
   - 認証失敗時、エラーメッセージを表示

2. **ダッシュボード表示**
   - ユーザー情報の表示
   - 権限に基づいたアプリケーション一覧の表示
   - ナビゲーションメニューの表示（権限に基づく）

3. **アプリケーションアクセス**
   - ユーザーがアプリケーションを選択
   - 権限チェック
   - 権限がある場合、アプリケーションページに遷移
   - アプリケーション設定に基づいて戻るボタン制御を適用
   - 権限がない場合、エラーメッセージを表示

4. **アプリケーション内操作**
   - アプリケーション機能の利用
   - 戻るボタンが禁止されている場合、ブラウザの戻るボタンやキーボードショートカットが無効化
   - ダッシュボードに戻る場合は専用ボタンを使用

5. **ユーザー管理**
   - 管理者がユーザー一覧を表示
   - ユーザーの作成、編集、削除が可能
   - パスワードリセット機能

6. **ロール管理**
   - 管理者がロール一覧を表示
   - ロールの作成、編集、削除が可能
   - 権限の割り当て/解除が可能

このシステムは、企業や組織内で複数のアプリケーションへのアクセスを一元管理するためのポータルサイトとして機能します。ロールベースのアクセス制御により、ユーザーごとに適切な権限を付与し、セキュリティを確保しながら必要なアプリケーションにアクセスできる環境を提供します。 